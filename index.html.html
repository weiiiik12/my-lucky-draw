<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>â˜ï¸ é›²ç«¯å¹¸é‹æŠ½æŠ½æ¨‚ V2.0</title>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    
    <style>
        /* (æ¨£å¼ä¿æŒè·Ÿä¹‹å‰å·®ä¸å¤šï¼Œå¢åŠ ç™»å…¥é ) */
        body { font-family: sans-serif; background: #f0f2f5; margin: 0; padding-bottom: 70px; }
        .page { display: none; padding: 20px; }
        .page.active { display: block; }
        .card { background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; }
        .btn { background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 20px; width: 80%; margin: 5px auto; display: block; cursor: pointer; }
        .btn-blue { background: #2196F3; }
        .input-box { padding: 10px; width: 70%; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; }
        .navbar { position: fixed; bottom: 0; width: 100%; background: white; display: flex; padding: 10px 0; border-top: 1px solid #ddd; }
        .nav-item { flex: 1; text-align: center; cursor: pointer; color: #777; }
        .nav-item.active { color: #4CAF50; font-weight: bold; }
        
        /* è¼‰å…¥é®ç½© */
        #loadingOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index: 999; display: flex; justify-content: center; align-items: center; font-size: 20px; display: none; }
    </style>
</head>
<body>

    <div id="loadingOverlay">â˜ï¸ é€£ç·šä¸­...</div>

    <div id="page-login" class="page active">
        <div class="card" style="margin-top: 50px;">
            <h2>ğŸ‘‹ æ­¡è¿ä¾†åˆ°å¹¸é‹æŠ½æŠ½æ¨‚</h2>
            <p>è«‹è¼¸å…¥ä½ çš„åå­—é–‹å§‹éŠæˆ²</p>
            <input type="text" id="usernameInput" class="input-box" placeholder="ä¾‹å¦‚ï¼šå°æ˜">
            <button class="btn btn-blue" onclick="login()">ğŸš€ ç™»å…¥ / è¨»å†Š</button>
            <p style="font-size: 12px; color: #888;">(å¦‚æœåå­—ç¬¬ä¸€æ¬¡å‡ºç¾ï¼Œæœƒè‡ªå‹•å¹«ä½ é–‹æ–°å¸³æˆ¶é€ 500 é»å–”ï¼)</p>
        </div>
    </div>

    <div id="app-content" style="display: none;">
        <div style="background: #2196F3; color: white; padding: 15px; text-align: center;">
            <span id="displayName">ç©å®¶</span> çš„éŒ¢åŒ…: ğŸ’° <span id="userPoints">---</span>
        </div>

        <div id="page-draw" class="page active">
            <div class="card">
                <h3>ğŸ é›²ç«¯æŠ½çæ©Ÿ</h3>
                <div style="font-size: 50px; margin: 20px;">â“</div>
                <p id="drawResultText">é»æ“Šä¸‹æ–¹æŒ‰éˆ•æŠ½ç (-100é»)</p>
                <button class="btn" onclick="drawGacha()">ğŸ° æŠ½ä¸€æ¬¡ (100é»)</button>
            </div>
            
            <div class="card">
                 <h4>ğŸ’ æˆ‘çš„èƒŒåŒ… (é›²ç«¯åŒæ­¥)</h4>
                 <div id="inventoryList" style="text-align: left; padding-left: 20px;">
                     è¼‰å…¥ä¸­...
                 </div>
            </div>
        </div>

        <div class="navbar">
            <div class="nav-item active">ğŸ  é¦–é </div>
            <div class="nav-item" onclick="logout()">ğŸšª ç™»å‡º</div>
        </div>
    </div>

    <script>
        // ğŸ”´ 1. è²¼ä¸Šä½ çš„ Firebase Config (é€™è£¡ä¸€å®šè¦æ”¹ï¼)
        const firebaseConfig = {
            apiKey: "AIzaSyA84BEQc_szhvmbVlxVR_mXnCQ0E4auqTg",
            authDomain: "hago-award-system.firebaseapp.com",
            projectId: "hago-award-system",
            storageBucket: "hago-award-system.firebasestorage.app",
            messagingSenderId: "959940017225",
            appId: "1:959940017225:web:85a36866320f53638f5398",
  	    measurementId: "G-HRS8GBGJ89"
        };

        // 2. åˆå§‹åŒ– Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let currentUser = null; // è¨˜ä½ç¾åœ¨æ˜¯èª°
        let currentDocId = null; // è¨˜ä½ä»–åœ¨è³‡æ–™åº«çš„é‚£å¼µç´™ID

        // --- ç™»å…¥ç³»çµ± ---
        async function login() {
            const name = document.getElementById('usernameInput').value.trim();
            if (!name) return alert("è«‹è¼¸å…¥åå­—ï¼");

            showLoading(true);

            try {
                // 1. å»é›²ç«¯æ‰¾æ‰¾çœ‹æœ‰æ²’æœ‰é€™å€‹äºº
                const usersRef = db.collection('users');
                const snapshot = await usersRef.where('name', '==', name).get();

                if (snapshot.empty) {
                    // A. æ²’æ‰¾åˆ° -> æ–°è¨»å†Š
                    const newUser = {
                        name: name,
                        points: 500, // æ–°æ‰‹ç¦®åŒ…
                        inventory: [],
                        createdAt: new Date() // è¨»å†Šæ™‚é–“
                    };
                    const docRef = await usersRef.add(newUser);
                    currentUser = newUser;
                    currentDocId = docRef.id;
                    alert(`æ­¡è¿æ–°æœ‹å‹ ${name}ï¼é€ä½  500 é»ï¼`);
                } else {
                    // B. æ‰¾åˆ°äº† -> è®€å–è³‡æ–™
                    const doc = snapshot.docs[0];
                    currentUser = doc.data();
                    currentDocId = doc.id;
                    alert(`æ­¡è¿å›ä¾†ï¼Œ${name}ï¼`);
                }

                // é€²å…¥ App
                document.getElementById('page-login').classList.remove('active');
                document.getElementById('app-content').style.display = 'block';
                updateUI();
                
            } catch (error) {
                console.error("ç™»å…¥å¤±æ•—", error);
                alert("é€£ç·šéŒ¯èª¤ï¼š" + error.message);
            }
            showLoading(false);
        }

        // --- æŠ½çç³»çµ± (é›²ç«¯ç‰ˆ) ---
        async function drawGacha() {
            if (!currentUser || !currentDocId) return;

            if (currentUser.points < 100) {
                alert("é»æ•¸ä¸è¶³ï¼è«‹æ‰¾ç®¡ç†å“¡å„²å€¼ï¼");
                return;
            }

            showLoading(true);

            // éš¨æ©ŸæŠ½çé‚è¼¯ (å‰ç«¯ç°¡å–®ç‰ˆ)
            const items = ['æ©¡çš®æ“¦', 'è²¼ç´™', 'å·§å…‹åŠ›', 'éº¥ç•¶å‹è–¯æ¢', '100å…ƒç©å…·'];
            const prize = items[Math.floor(Math.random() * items.length)];

            try {
                // é›²ç«¯äº¤æ˜“ï¼šæ‰£éŒ¢ + çµ¦çå“
                // é€™è£¡æˆ‘å€‘ç›´æ¥æ›´æ–°è³‡æ–™åº«
                const userRef = db.collection('users').doc(currentDocId);

                await db.runTransaction(async (transaction) => {
                    const doc = await transaction.get(userRef);
                    if (!doc.exists) throw "User does not exist!";

                    const newPoints = doc.data().points - 100;
                    if (newPoints < 0) throw "é»æ•¸ä¸è¶³";

                    const newInventory = doc.data().inventory || [];
                    newInventory.push({
                        name: prize,
                        date: new Date().toISOString()
                    });

                    transaction.update(userRef, { 
                        points: newPoints,
                        inventory: newInventory
                    });
                    
                    // æ›´æ–°æœ¬åœ°é¡¯ç¤º
                    currentUser.points = newPoints;
                    currentUser.inventory = newInventory;
                });

                document.getElementById('drawResultText').innerText = `ğŸ‰ æ­å–œç²å¾—ï¼š${prize}`;
                updateUI();

            } catch (e) {
                console.error("äº¤æ˜“å¤±æ•—", e);
                alert("äº¤æ˜“å¤±æ•—ï¼š" + e);
            }
            showLoading(false);
        }

        // --- UI æ›´æ–° ---
        function updateUI() {
            document.getElementById('displayName').innerText = currentUser.name;
            document.getElementById('userPoints').innerText = currentUser.points;

            const list = document.getElementById('inventoryList');
            if (!currentUser.inventory || currentUser.inventory.length === 0) {
                list.innerHTML = "èƒŒåŒ…ç©ºç©ºçš„...";
            } else {
                list.innerHTML = currentUser.inventory.map(item => `
                    <div style="border-bottom:1px solid #eee; padding:5px;">
                        ğŸ ${item.name} <span style="font-size:10px; color:#999">(${item.date.split('T')[0]})</span>
                    </div>
                `).join('');
            }
        }

        function logout() {
            location.reload(); // é‡æ–°æ•´ç†ç¶²é å°±æ˜¯ç™»å‡º
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }
    </script>
</body>
</html>