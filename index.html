<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸŒŸ Hago çå‹µç³»çµ±</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --primary: #4CAF50;
            --danger: #ff4757;
            --text: #2f3542;
        }
        /* ç¨€æœ‰åº¦é¡è‰²å®šç¾© */
        .rank-common { color: #57606f; background: #dfe4ea; border-color: #ced6e0; }
        .rank-rare { color: #1e90ff; background: #dff9fb; border-color: #70a1ff; }
        .rank-epic { color: #a55eea; background: #f3e5f5; border-color: #d980fa; }
        .rank-legendary { color: #ffa502; background: #fff3cd; border-color: #ffeaa7; box-shadow: 0 0 10px rgba(255, 165, 2, 0.4); }

        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-color); color: var(--text); margin: 0; padding-bottom: 80px; -webkit-tap-highlight-color: transparent; }
        
        .header { background: linear-gradient(135deg, #6c5ce7, #a29bfe); color: white; padding: 20px; text-align: center; border-radius: 0 0 20px 20px; box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3); }
        .points-box { font-size: 2.5em; font-weight: bold; margin-top: 5px; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
        
        .container { padding: 15px; max-width: 600px; margin: 0 auto; }
        .card { background: var(--card-bg); border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); text-align: center; transition: transform 0.2s; }
        .card:active { transform: scale(0.98); }

        .btn { border: none; padding: 14px 24px; border-radius: 50px; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%; transition: 0.2s; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn-draw { background: linear-gradient(45deg, #ff4757, #ff6b81); color: white; box-shadow: 0 4px 15px rgba(255, 71, 87, 0.4); }
        .btn-blue { background: #2ed573; color: white; }
        
        /* æŠ½ççµæœå‹•ç•« */
        #resultArea { min-height: 150px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .result-icon { font-size: 60px; margin-bottom: 10px; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .result-name { font-size: 1.2em; font-weight: bold; padding: 5px 15px; border-radius: 10px; display: inline-block; border: 2px solid transparent; }
        
        /* èƒŒåŒ…ç¶²æ ¼ */
        .inventory-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .inv-item { background: white; border: 2px solid #eee; border-radius: 12px; padding: 10px 5px; text-align: center; font-size: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 80px; }
        .inv-icon { font-size: 24px; margin-bottom: 5px; }

        /* åº•éƒ¨å°èˆª */
        .navbar { position: fixed; bottom: 0; width: 100%; background: white; display: flex; padding: 12px 0; box-shadow: 0 -2px 20px rgba(0,0,0,0.05); z-index: 100; border-radius: 20px 20px 0 0; }
        .nav-item { flex: 1; text-align: center; color: #a4b0be; font-size: 10px; cursor: pointer; }
        .nav-item.active { color: #6c5ce7; font-weight: bold; }
        .nav-icon { font-size: 20px; display: block; margin-bottom: 2px; }

        /* ç™»å…¥é  */
        #login-page { position: fixed; top:0; left:0; width:100%; height:100%; background: #f0f2f5; z-index: 999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        input[type="text"] { padding: 15px; width: 70%; border: 2px solid #eee; border-radius: 12px; font-size: 16px; margin-bottom: 20px; text-align: center; outline: none; }
        input[type="text"]:focus { border-color: #6c5ce7; }

        @keyframes popIn { 0% { transform: scale(0); } 80% { transform: scale(1.2); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div id="login-page">
        <div style="font-size: 50px; margin-bottom: 20px;">ğŸ’</div>
        <h2 style="color: #6c5ce7;">Hago çå‹µç³»çµ±</h2>
        <input type="text" id="usernameInput" placeholder="è«‹è¼¸å…¥ä½ çš„åå­—">
        <button class="btn btn-blue" style="width: 80%;" onclick="login()">é–‹å§‹éŠæˆ²</button>
    </div>

    <div id="app-content" style="display: none;">
        
        <div class="header">
            <div style="font-size: 14px; opacity: 0.8;">ğŸ‘‹ å—¨ï¼Œ<span id="displayName">--</span></div>
            <div class="points-box">ğŸ’° <span id="userPoints">0</span></div>
            <div style="font-size: 12px; margin-top: 5px;">æŒæœ‰ä»£å¹£</div>
        </div>

        <div class="container">
            <div id="tab-draw" class="tab-content">
                <div class="card">
                    <div style="color: #888; font-size: 12px; margin-bottom: 10px;">âœ¨ è©¦è©¦æ‰‹æ°£ âœ¨</div>
                    <div id="resultArea">
                        <div class="result-icon">â“</div>
                        <div class="result-name">æº–å‚™æŠ½ç</div>
                    </div>
                    <div style="margin: 20px 0; height: 1px; background: #eee;"></div>
                    <button id="drawBtn" class="btn btn-draw" onclick="drawGacha()">
                        <span>ğŸ°</span> å•Ÿå‹•è½‰ç›¤ (-100)
                    </button>
                    <div style="margin-top: 10px; font-size: 12px; color: #999;">
                        ğŸ§¡ å‚³å¥‡ 5% | ğŸ’œ å²è©© 15% | ğŸ’™ ç¨€æœ‰ 30% | ğŸ¤ æ™®é€š 50%
                    </div>
                </div>
            </div>

            <div id="tab-bag" class="tab-content" style="display: none;">
                <div class="card" style="min-height: 300px;">
                    <h3>ğŸ’ æˆ‘çš„å¯¶ç‰©åº«</h3>
                    <div id="inventoryList" class="inventory-grid">
                        </div>
                    <div id="emptyMsg" style="color:#ccc; margin-top: 50px; display:none;">èƒŒåŒ…ç©ºç©ºçš„...<br>å¿«å»æŠ½çå§ï¼</div>
                </div>
            </div>
        </div>

        <div class="navbar">
            <div class="nav-item active" onclick="switchTab('draw', this)">
                <span class="nav-icon">ğŸ°</span>æŠ½ç
            </div>
            <div class="nav-item" onclick="switchTab('bag', this)">
                <span class="nav-icon">ğŸ’</span>èƒŒåŒ…
            </div>
            <div class="nav-item" onclick="logout()">
                <span class="nav-icon">ğŸšª</span>ç™»å‡º
            </div>
        </div>
    </div>

    <script>
        // ğŸ”´ ä½ çš„ Hago Award System å°ˆå±¬é‡‘é‘° (å·²å¹«ä½ å¡«å¥½ï¼)
        const firebaseConfig = {
            apiKey: "AIzaSyA84BEQc_szhvmbVlxVR_mXnCQ0E4auqTg",
            authDomain: "hago-award-system.firebaseapp.com",
            projectId: "hago-award-system",
            storageBucket: "hago-award-system.firebasestorage.app",
            messagingSenderId: "959940017225",
            appId: "1:959940017225:web:85a36866320f53638f5398",
            measurementId: "G-HRS8GBGJ89"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- ğŸŒŸ çå“èˆ‡æ©Ÿç‡è¨­å®šå€ (ä½ å¯ä»¥è‡ªç”±ä¿®æ”¹é€™è£¡ï¼) ---
        const prizePool = {
            legendary: { rate: 0.05, items: ['éŠæ¨‚åœ’é–€ç¥¨', '500å…ƒç©å…·', 'ä¸ç”¨åšå®¶äº‹åˆ¸'], icon: 'ğŸ§¡', class: 'rank-legendary', name: 'å‚³å¥‡' },
            epic:      { rate: 0.15, items: ['éº¥ç•¶å‹å¥—é¤', 'æŒ‘é¸æ™šé¤æ¬Š', '100å…ƒé›¶ç”¨éŒ¢'], icon: 'ğŸ’œ', class: 'rank-epic', name: 'å²è©©' },
            rare:      { rate: 0.30, items: ['è–¯æ¢ä¸€ä»½', '30åˆ†é˜é›»è¦–', 'å·§å…‹åŠ›ä¸€æ¢'], icon: 'ğŸ’™', class: 'rank-rare', name: 'ç¨€æœ‰' },
            common:    { rate: 0.50, items: ['æ©¡çš®æ“¦', 'è²¼ç´™', 'é‰›ç­†', 'å¥½æ£’æ£’å°ç« '], icon: 'ğŸ¤', class: 'rank-common', name: 'æ™®é€š' }
        };

        let currentUser = null;
        let currentDocId = null;

        // --- ç™»å…¥é‚è¼¯ ---
        async function login() {
            const name = document.getElementById('usernameInput').value.trim();
            if (!name) return alert("è«‹è¼¸å…¥åå­—");
            
            const btn = document.querySelector('#login-page button');
            btn.innerText = "é€£ç·šä¸­...";
            btn.disabled = true;

            try {
                const usersRef = db.collection('users');
                const snapshot = await usersRef.where('name', '==', name).get();

                if (snapshot.empty) {
                    const newUser = { name: name, points: 500, inventory: [], createdAt: new Date() };
                    const docRef = await usersRef.add(newUser);
                    currentUser = newUser;
                    currentDocId = docRef.id;
                } else {
                    const doc = snapshot.docs[0];
                    currentUser = doc.data();
                    currentDocId = doc.id;
                }
                
                document.getElementById('login-page').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
                updateUI();
                
            } catch (e) {
                alert("é€£ç·šå¤±æ•—ï¼š" + e.message);
                btn.innerText = "é–‹å§‹éŠæˆ²";
                btn.disabled = false;
            }
        }

        // --- æŠ½çæ ¸å¿ƒé‚è¼¯ (å«æ©Ÿç‡) ---
        async function drawGacha() {
            if (currentUser.points < 100) return alert("é»æ•¸ä¸è¶³ï¼è«‹æ‰¾å®¶é•·å„²å€¼ï¼");
            
            const btn = document.getElementById('drawBtn');
            btn.disabled = true; // é˜²æ­¢é€£æŒ‰
            btn.innerText = "ğŸ² è½‰å‹•ä¸­...";

            // 1. è¨ˆç®—æ©Ÿç‡
            const rand = Math.random(); 
            let selectedTier = 'common';
            
            // ç´¯åŠ æ©Ÿç‡åˆ¤å®š
            if (rand < prizePool.legendary.rate) selectedTier = 'legendary';
            else if (rand < prizePool.legendary.rate + prizePool.epic.rate) selectedTier = 'epic';
            else if (rand < prizePool.legendary.rate + prizePool.epic.rate + prizePool.rare.rate) selectedTier = 'rare';
            else selectedTier = 'common';

            // 2. éš¨æ©Ÿé¸çå“
            const pool = prizePool[selectedTier];
            const item = pool.items[Math.floor(Math.random() * pool.items.length)];
            
            // 3. å¯«å…¥è³‡æ–™åº«
            try {
                const userRef = db.collection('users').doc(currentDocId);
                await db.runTransaction(async (t) => {
                    const doc = await t.get(userRef);
                    const newPoints = doc.data().points - 100;
                    if(newPoints < 0) throw "é»æ•¸ä¸è¶³";
                    
                    const newInventory = doc.data().inventory || [];
                    newInventory.push({
                        name: item,
                        tier: selectedTier,
                        date: new Date().toISOString()
                    });

                    t.update(userRef, { points: newPoints, inventory: newInventory });
                    currentUser.points = newPoints;
                    currentUser.inventory = newInventory;
                });

                // 4. å‹•ç•«
                showResultAnim(item, selectedTier);

            } catch (e) {
                alert("äº¤æ˜“å¤±æ•—ï¼š" + e);
            }
            
            btn.disabled = false;
            btn.innerHTML = "<span>ğŸ°</span> å•Ÿå‹•è½‰ç›¤ (-100)";
        }

        function showResultAnim(name, tier) {
            const area = document.getElementById('resultArea');
            const conf = prizePool[tier];
            
            let count = 0;
            const timer = setInterval(() => {
                area.innerHTML = `<div class="result-icon">${['ğŸ²','â­','ğŸ'][count%3]}</div><div class="result-name">...</div>`;
                count++;
                if(count > 5) {
                    clearInterval(timer);
                    area.innerHTML = `
                        <div class="result-icon" style="animation: popIn 0.5s;">${conf.icon}</div>
                        <div class="result-name ${conf.class}">${name}</div>
                        <div style="font-size:12px; color:#999; margin-top:5px;">${conf.name}</div>
                    `;
                    updateUI();
                }
            }, 100);
        }

        function updateUI() {
            document.getElementById('displayName').innerText = currentUser.name;
            document.getElementById('userPoints').innerText = currentUser.points;

            const list = document.getElementById('inventoryList');
            const inv = currentUser.inventory || [];
            
            if (inv.length === 0) {
                document.getElementById('emptyMsg').style.display = 'block';
                list.innerHTML = '';
            } else {
                document.getElementById('emptyMsg').style.display = 'none';
                list.innerHTML = [...inv].reverse().map(i => {
                    const conf = prizePool[i.tier] || prizePool.common;
                    return `
                    <div class="inv-item ${conf.class}">
                        <div class="inv-icon">${conf.icon}</div>
                        <div style="font-weight:bold;">${i.name}</div>
                    </div>`;
                }).join('');
            }
        }

        function switchTab(tab, el) {
            document.querySelectorAll('.tab-content').forEach(d => d.style.display = 'none');
            document.getElementById('tab-' + tab).style.display = 'block';
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
        }

        function logout() { location.reload(); }
    </script>
</body>
</html>